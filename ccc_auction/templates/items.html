<!DOCTYPE html>
<html lang="en" dir="ltr">
    <head>
        <meta charset="uft-8">
        <title>Items</title>
    </head>
    <body>
        {% extends "template.html" %}
        {% block content %}

        <div class="items-page-title">
            <h1> Here is what's for sale </h1>
        </div>

        <div class="row">
            {% for column in columns %}
            <div class="column">
                {% for item,form in column %}
                    <div class="item-holder">
                        <h3>{{ item.itemname }}</h3>                   
                        <div class="image-holder">
                            <figure id={{ item.image_file }} data-toggle="modal" data-target=#{{ item.id }}>
                                <img src={{ url_for('static', filename=item.image_file) }} class="small-display">
                            </figure>
                        </div>

                        <div class="modal fade" id={{ item.id }} tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
                            <div class="modal-dialog" role="document">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <img src={{ url_for('static', filename=item.image_file) }} class="modal-image">
                                    </div>
                                    <div class="modal-body">
                                        {{ item.description }}
                                    </div>
                                    {% if item.restrictions %}
                                    <div class="modal-body">
                                        Note: {{ item.restrictions }}
                                    </div>
                                    {% endif %}
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <p>Value - ${{ item.list_value }}</p>
                        <b>Current Bid: ${{ item.current_bid }}</b>
                        <p>Next Bid: ${{ item.current_bid + item.raise_value }}</p>

                        <!-- Changed class from "modal fade" -->
                        <div class="modal" id={{ item.id * 100 }} tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
                            <div class="modal-dialog" role="document">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="exampleModalLabel">Confirm Bid on {{ item.itemname }} for ${{ item.current_bid + item.raise_value }}</h5>
                                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                            <span aria-hidden="true">&times;</span>
                                        </button>
                                    </div>
                                    <div class="modal-body">
                                        <form method="POST" action="">
                                            {{ form.hidden_tag() }}
                                            <div class="form-group">
                                                {{ form.submit(class="btn btn-outline-info") }}
                                            </div>
                                        </form>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <script>
                        function checkTimeLoadModal(id) {
                            var openTimePython = document.getElementById(id*1000000).innerText;
                            var closeTimePython = document.getElementById(id*100000000).innerText;

                            var openTimeString = openTimePython.slice(0,10) + "T" + openTimePython.slice(12) + "Z";
                            var closeTimeString = closeTimePython.slice(0,10) + "T" + closeTimePython.slice(12) + "Z";

                            var openTime = new Date(openTimeString);
                            var closeTime = new Date(closeTimeString);

                            var modalID = "#" + id*100;

                            var messageOpen = openTime.getMonth() + "/" + openTime.getDay() + "/" + openTime.getFullYear() + " at " + openTime.getHours() + ":" + ('0'+openTime.getMinutes()).slice(-2);
                            var messageClosed = closeTime.getMonth() + "/" + closeTime.getDay() + "/" + closeTime.getFullYear() + " at " + closeTime.getHours() + ":" + ('0'+closeTime.getMinutes()).slice(-2);


                            if (today < openTime) {
                                $(modalID).modal('toggle')
                                document.getElementById(id*10000).innerHTML = "Bidding on this item starts " + messageOpen;
                                document.getElementById(id*10000).style.display = "block";
                            } else if (today >= closeTime) {
                                $(modalID).modal('toggle')
                                document.getElementById(id*10000).innerHTML = "Bidding on this item starts " + messageClosed;
                                document.getElementById(id*10000).style.display = "block";
                            }
                        };
                        var today = new Date();
                        </script>

                        <button type="button" class="btn btn-success" data-toggle="modal" data-target=#{{ item.id * 100 }} onclick=checkTimeLoadModal({{ item.id }})>
                            Place Bid
                        </button>
                        <p></p>
                        <div id={{ item.id * 10000 }} class="open-status"></div>
                        <div id={{ item.id * 1000000 }} class="hidden-time">
                            <p>{{ item.open_time }}</p>
                        </div>
                        <div id={{ item.id * 100000000 }} class="hidden-time">
                            <p>{{ item.close_time }}</p>
                        </div>

                    </div>
                {% endfor %}
            </div>
            {% endfor %}
        </div>
        {% endblock %}
    </body>
</html>